<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Votes du sondage</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="config.js"></script>
  <style>
    .admin-container {
      max-width: 800px;
      width: 100%;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: var(--space);
      margin-bottom: var(--space-xl);
    }
    .stat-card {
      padding: var(--space-lg);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      text-align: center;
    }
    .stat-card .number {
      font-size: 2rem;
      font-weight: 600;
      color: var(--accent);
      display: block;
      margin-bottom: 0.25rem;
    }
    .stat-card .label {
      font-size: 0.875rem;
      color: var(--text-muted);
    }
    .votes-list {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--space-lg);
    }
    .vote-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: var(--space-lg);
      padding: var(--space);
      border-bottom: 1px solid var(--border);
      align-items: center;
    }
    .vote-item:last-child {
      border-bottom: none;
    }
    .vote-id {
      font-family: monospace;
      font-size: 0.75rem;
      color: var(--text-muted);
      background: var(--bg-soft);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    .vote-choix {
      font-weight: 500;
    }
    .vote-date {
      font-size: 0.875rem;
      color: var(--text-muted);
      white-space: nowrap;
    }
    .empty-state {
      text-align: center;
      padding: var(--space-xl);
      color: var(--text-muted);
    }
    .btn-export {
      margin-bottom: var(--space-lg);
      padding: 0.75rem var(--space-lg);
      background: var(--accent);
      color: #0c0c10;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      cursor: pointer;
      transition: background var(--transition);
    }
    .btn-export:hover {
      background: var(--accent-hover);
    }
  </style>
</head>
<body>
  <main class="admin-container">
    <h1>Administration – Votes du sondage</h1>
    <p class="intro">Vue détaillée de tous les votes individuels</p>

    <div id="stats-container" class="stats-grid"></div>

    <button class="btn-export" id="btn-export">Exporter les données (JSON)</button>

    <section class="votes-list">
      <h2 style="margin-top: 0; margin-bottom: var(--space-lg);">Liste des votes</h2>
      <div id="votes-container"></div>
    </section>
  </main>
  <script>
    (function () {
      const API_URL = window.API_URL || 'https://sondage-api.onrender.com';

      const statsContainer = document.getElementById('stats-container');
      const votesContainer = document.getElementById('votes-container');
      const btnExport = document.getElementById('btn-export');

      function getVotes() {
        return fetch(API_URL + '/api/votes')
          .then(function (r) { return r.ok ? r.json() : Promise.reject(); })
          .then(function (data) { return { votes: data.votes || [], counts: data.counts || {} }; })
          .catch(function () { return { votes: [], counts: {} }; });
      }

      function formatDate(timestamp) {
        var d = new Date(timestamp);
        return d.toLocaleString('fr-FR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      function afficherStats(counts, totalVotes) {
        statsContainer.innerHTML =
          '<div class="stat-card">' +
          '<span class="number">' + totalVotes + '</span>' +
          '<span class="label">Total votes</span>' +
          '</div>';
        Object.keys(counts).forEach(function (type) {
          var n = counts[type] || 0;
          var pct = totalVotes > 0 ? Math.round((n / totalVotes) * 100) : 0;
          statsContainer.innerHTML +=
            '<div class="stat-card">' +
            '<span class="number">' + n + '</span>' +
            '<span class="label">' + escapeHtml(type) + ' (' + pct + '%)</span>' +
            '</div>';
        });
      }

      function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      }

      function afficherVotes(votes) {
        if (votes.length === 0) {
          votesContainer.innerHTML = '<div class="empty-state">Aucun vote enregistré pour le moment.</div>';
          return;
        }
        votesContainer.innerHTML = '';
        votes.sort(function (a, b) { return b.timestamp - a.timestamp; });
        votes.forEach(function (vote) {
          var div = document.createElement('div');
          div.className = 'vote-item';
          div.innerHTML =
            '<span class="vote-id">' + escapeHtml(vote.id.substr(0, 8)) + '…</span>' +
            '<span class="vote-choix">' + escapeHtml(vote.choix) + '</span>' +
            '<span class="vote-date">' + formatDate(vote.timestamp) + '</span>';
          votesContainer.appendChild(div);
        });
      }

      btnExport.addEventListener('click', function () {
        getVotes().then(function (data) {
          var exportData = {
            votes: data.votes,
            counts: data.counts,
            exportDate: new Date().toISOString()
          };
          var blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'votes-sondage-' + Date.now() + '.json';
          a.click();
          URL.revokeObjectURL(url);
        });
      });

      getVotes().then(function (data) {
        var votes = data.votes;
        var counts = data.counts;
        var total = Object.keys(counts).reduce(function (acc, k) { return acc + (counts[k] || 0); }, 0);
        afficherStats(counts, total);
        afficherVotes(votes);
      });
    })();
  </script>
</body>
</html>
